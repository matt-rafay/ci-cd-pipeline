on:
  create:
    branches-ignore:
      - "master"
    tags:
      - "v*.*"
    paths:
      - "build/**"
  push:
    branches:
      - "master"
    paths:
      - "build/**"

env:
  GIT_USER_EMAIL: ${{ secrets.GIT_USER_EMAIL }}
  GIT_USER_NAME: ${{ secrets.GIT_USER_NAME }}
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  REGISTRY_FQDN: registry.rafay.us
  REGISTRY_PASSWORD: ${{ secrets.REGISTRY_PASSWORD }}
  REGISTRY_USERNAME: ${{ secrets.REGISTRY_USERNAME }}
  REPOSITORY_NAME: ci-cd-demo-app

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: checkout repository
        uses: actions/checkout@v2
        with:
          fetch-depth: 2
        
      - name: configure git
        if: github.event_name == 'create' || github.event.pull_request.merged == true
        run: |
          git config --global user.name "${GIT_USER_NAME}"
          git config --global user.email "${GIT_USER_EMAIL}"
        
      - name: registry login
        uses: docker/login-action@v1
        with:
          registry: ${{ env.REGISTRY_FQDN }}
          username: ${{ env.REGISTRY_USERNAME }}
          password: ${{ env.REGISTRY_PASSWORD }}
        
      - name: set tags
        run: |
          if [[ ${GITHUB_REF} == refs/heads/* ]]; then
            BRANCH=${GITHUB_REF#refs/heads/*}
            if [[ ${BRANCH} == master ]]; then
              VERSION=lastest
            else
              VERSION=${BRANCH}
            fi
          else
            TAG=${GITHUB_REF#refs/tags/*}
            VERSION=${TAG}
          fi
          
          echo "BRANCH=${BRANCH}" >> $GITHUB_ENV
          echo "TAG=${TAG}" >> $GITHUB_ENV
          echo "VERSION=${VERSION}" >> $GITHUB_ENV
        
      - name: test
        run: |
          echo ${BRANCH}
          echo ${TAG}
          echo ${VERSION}